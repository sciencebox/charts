#
# ScienceBox
#
sciencebox:
  # sss keytab for eos
  #   Will be used by eos server ('eos:' section) and fusex ('swan:fusex:' section).
  #   Options:
  #     - createSecret: Create a secret either from file or from value.
  #         If set to false, no secrets will be automatically generated. In this case, secretName must
  #         be set to an existing secret containering the sss keytab
  #     - secretName: Name of the secret containing the sss keytab
  #     - fromFile: Provide the path to a file containing the eos keytab (defaults to files/eos.keytab)
  #         A secret with name <secretName> will be created from it
  #     - fromValue: Provide the full keytab as a string
  #         Example: "0 u:daemon g:daemon n:eos-test+ N:69275826269580...
  #         A secret with name <secretName> will be created from it
  sssKeytab:
    createSecret: true
    secretName: &sssKeytabName sciencebox-eos-sss-keytab
    fromFile: files/eos.keytab
    #fromValue:

#
# Global values
#
global:
  #
  # EOS image tag:
  #   - Used by eos-server (qdb, mq, mgm, fst) (eos-all image)
  #             eos-instance-config (eos-all image)
  #             fusex in SWAN (eos-fusex image)
  tag: 4.8.78
  #
  # SSS keytab:
  #   - Anchor from sciencebox:sssKeytab
  #   - Used by eos-server (qdb, mq, mgm, fst) and eos-instance-config
  sssKeytab:
    secret: *sssKeytabName


#
# OCIS-IDP
#
ocis-idp:
  env:
    # Set access token expiration to 8hrs (=28800s) until the auto-renewal is fixed
    IDP_ACCESS_TOKEN_EXPIRATION: 28800
    IDP_ISS: https://idp.hostname
  configFiles:
    identifier_registration.yaml: |
      clients:
        - id: swan
          secret: 4a045535-6b99-49d3-bf41-8b410cd965a6
          name: SWAN
          application_type: native
  ingress:
    enabled: true
    hosts:
    exposeIdp: true

#
# EOS
#
eos:
  mgm:
    mgmofs:
      instance: user
    ldapBindUsers:
      enable: true
      nslcd:
       config:
         ldap_uri: ldap://sciencebox-ocis-idp.default.svc.cluster.local:9389
         ldap_base: ou=users,dc=example,dc=org
         ldap_binddn: cn=idp,ou=sysusers,dc=example,dc=org
         ldap_bindpw: idp
         ldap_user_search_base: dc=example,dc=org
         ldap_group_search_base: ou=groups,dc=example,dc=org
         ldap_filter_passwd: (objectClass=posixAccount)
         ldap_filter_group: (objectClass=group)
  fst:
    replicaCount: 4

#
# SWAN
#
swan:
  #
  # CVMFS mounts
  cvmfs:
    deployDaemonSet: &cvmfsDeployDS true
    deployCsiDriver: &cvmfsDeployCSI false
    useCsiDriver: &cvmfsUseCSI false
    repositories: &cvmfsRepos
      - cvmfs-config.cern.ch
      - sft.cern.ch
      - sft-nightlies.cern.ch
  #
  # EOS Fusex mount
  eos:
    deployDaemonSet: &eosDeployDS true
    deployCsiDriver: &eosDeployCSI false
    useCsiDriver: &eosUseCSI false
  fusex:
    fusex:
      keytab:
        secret: *sssKeytabName
      hostMountpoint: /var/eos
      config:
        oauth2: 1
        sss: 0
        eos_mgm_alias: "sciencebox-mgm.default.svc.cluster.local"
  #
  # JupyterHub
  jupyterhub:
    proxy:
      secretToken: 11df35dab7527b3798de5224f06458db1e0526fa65700e81e18f17f89822e0cf
    hub:
      image:
        name: "gitlab-registry.cern.ch/sciencebox/hotfixes/jupyterhub"
        tag: "v1.18-20220314"
        pullPolicy: "Always"
      # The default (pvc) is not working in openstack...
      # TODO: Add some persistency here
      db:
        type: sqlite-memory
      extraEnv:
        JUPYTERHUB_CRYPT_KEY: 8b9fa8fc38c56eb4b3194d875924bb27062635b038b75ffbc91d9a6212bd3e55
      cookieSecret: 07006b4975f06166c988122e78603740788e93846265b0aec791c387a9a83925
      config:
        SwanKubeSpawner:
          local_home: True
        KeyCloakAuthenticator:
          oidc_issuer: https://idp.hostname
          client_id: swan
          client_secret: 4a045535-6b99-49d3-bf41-8b410cd965a6
          oauth_callback_url: https://sciencebox.hostname/swan/hub/oauth_callback
          tls_verify: false     # Accept self-signed/invalid certificate from OCIS IDP
          scope:
            - openid
            - email
            - profile
            - offline_access
          jwt_signing_algorithms:
            - HS256
            - RS256
            - PS256
          # With the CERN SSO we will get a valid token for EOS. If the eosxd supports oauth,
          # we will be able to use it from the terminal, even with local_home=True.
          # The oCIS idp probably doesn't support exchanging tokens, but we will be able to re-use
          # the swan token with EOS if needed (although we shouldn't)
          exchange_tokens:
          ##   - eos-service
          ##   - cernbox-service
        JupyterHub:
          # We should expose cernbox and swan from the same url to simplify the deployment
          # We can do that by using different base url's for each.
          # I hope this simplifies the ScienceBox ingress as well
          base_url: /swan
      extraConfig:
        # TODO change the config to use the oCIS idp
        # Might need fixes on the swan code cause we break if we don't set user_roles (at least when using GPU).
        00-authConf: |
          def pre_spawn_hook(authenticator, spawner, auth_state):
            spawner.environment['ACCESS_TOKEN'] = auth_state['access_token']
            spawner.environment['OAUTH_INSPECTION_ENDPOINT'] = authenticator.userdata_url.replace('https://', '')
            spawner.user_uid = str(1000) # Fake value -- Nobody uses this.
            decoded_token = authenticator._decode_token(auth_state['access_token'])
            spawner.user_roles = authenticator.claim_roles_key(authenticator, decoded_token)
          c.KeyCloakAuthenticator.pre_spawn_hook = pre_spawn_hook
        02-spawnError: |
          cernbox_url = 'CHANGE_ME' #TODO: This should come from the ScienceBox config !! If necessary, this can come as an env var

          SPAWN_ERROR_MESSAGE = f"""SWAN could not start a session for your user, please try again. If the problem persists, please check:
          <ul>
              <li>Do you have a CERNBox account? If not, click <a href="{cernbox_url}" target="_blank">here</a>.</li>
              <li>Check with the service manager that SWAN is running properly.</li>
          </ul>"""
          c.SpawnHandlersConfigs.spawn_error_message = SPAWN_ERROR_MESSAGE
        03-simpleForm: |
          # Remove this to enable the full form
          c.SwanSpawner.options_form = open('/srv/jupyterhub/jupyterhub_form.html').read()
    singleuser:
      cpu:
        limit: .5
        guarantee: .5
      extraEnv:
        # The sharing functionality won't work because we are deploying oCIS and not oc10
        # This will be replaced in the future with the CS3 APIs
        # SHARE_CBOX_API_DOMAIN: LOCAL_CBOX_URL__CHANGE_ME
        # SHARE_CBOX_API_BASE: /cernbox/swanapi/v1
        HELP_ENDPOINT: https://raw.githubusercontent.com/swan-cern/help/up2u/
        # FIXME Create a galery for ScienceBox? Or the normal one should redirect to different instances?
        # GALLERY_URL: https://swan-gallery.web.cern.ch/

    # TODO For some reason this is not working... We're still debugging
    prePuller:
      hook:
        enabled: false

    ingress:
      enabled: false
      annotations:
        kubernetes.io/ingress.class: nginx
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
        #nginx.ingress.kubernetes.io/rewrite-target: /
        #nginx.ingress.kubernetes.io/secure-backends: "true"
      hosts:
      # tls:
      #   - secretName: swan-tls-cert
      #     hosts:
      #       - test.mydomain
    custom:
      cvmfs:
        deployDaemonSet: *cvmfsDeployDS
        deployCsiDriver: *cvmfsDeployCSI
        useCsiDriver: *cvmfsUseCSI
        repositories: *cvmfsRepos
      eos:
        deployDaemonSet: *eosDeployDS
        deployCsiDriver: *eosDeployCSI
        useCsiDriver: *eosUseCSI


  # To decide if we keep this or we manage the tls secret differently
  # If we keep it, maybe should change the name from swan.secrets.ingress to smth else
  # swan:
  #   secrets:
  #     ingress:
  #       cert:
  #       key:

#
# NGINX
#   This is a simple nginx web server to provide a landing page to ScienceBox users.
#
nginx:
  ingress:
    enabled: true
    tls: true
    secrets:
      - name: jimil-tls
        key: "-----BEGIN PRIVATE KEY-----
MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQC+CTlf/usQLrcN
dzwYIppDMYHjTBZDb5jqIwnlj7hHcLGtPzTHkq8Ngw+8Jz3r+iIr3ppJNxiS6FOO
3uXAwMgqk8VOReRJ8w0b7Emi2BiwsHtKNS/m7+Bi1ide/Pl6M3GCTeWhNB71puwr
pX8Gh7STMraBNSdGCzc9c+foyj6ffAx+86/VTBebhaHaU+c99XOSRpWP4SlDQSm2
nLdei1lFfjxGyjscEqSLIllJUji2ZzyJLxKwWWy2z7VNhcIvf2N8wI3xQUI/7IcP
0qO/jOwgtlI/n9eSlNlOoiJ9lMnbw/IjhQAwS5ffHEE7SrvxjElPPWQdQRtfLTfA
CA0gOQh1AgMBAAECggEAUzBUhnpgSlA439MvYl1bbEiy1F6NbG3g4bX+8hgtElD5
5p5Bq4/Bw8d4zuPazn9MECo9HgnZXw4G7gcTSoLZ3RGdELu1yM12EqAoR/oTLN3E
yuJnms+tSXb3+zQAvgbhDKqu+BeJ6f1ta1niNmiXmsxbakpra9UjFGq1vYkzSrrQ
3WjfhIoa0iWerAV3E5VGXN9uuDNuVRNIt4F1z0kf8d/APuujWnoKG+jLulmwd2se
pkqeLTV+WIwylwurq7XdJo5Yw5yHFsYdiokKEdIdoMDSp1Y4X6bmMhF057ZF39ql
eKbPzOe7ZUe05IDuEhY0D3e4xxTVnzlxuhzGnxC84QKBgQDdFeqhT3CqVo/cUdEx
8w9RG5D7tIP7qBdP2x6M9AMCrtiu3DIPdVbe87fZG8rxmf9IDibnXiedXmNCLTuI
wtaLgauzXulzl8kd6flm5PjDW357nF/Jc8t2It4TX02sNpX3M5wte75R42BCeob4
enygwKWXne4ue+8Q2HXT1eNr7QKBgQDcDAfFvaz1yM53V3wfNiPpNetU6zy14wj2
LogDoQA4b8wk/8QUXEq+jSxF4Xi5vQvySmymbZ5mvMdnSqxWm+4pNKZoUX6ylNpx
N7UzOhL0f7zIYsNGSx+/jdFmTBacz01A4AqVsL7reXHSwmPsINnU9lGyAYJWXoa3
bhOD/RLNqQKBgEtYj8j/6Na0f3zHiXLrchnjOir+H0jhxWgatjO1aV09t20IcCsi
g0OibdKZDTX/lKe64vlQ9lFEfLFt9u8p77JFs/2CaC9T2F/QgIXXnQv/H4EDDwX5
56pQQbz6at85DyzbMuuxU3BW/FRLq7n9DIJAhW7BjQ3cgOIN00Ipj8MVAoGAFdZ7
zvwL9jh/hQiBoPdWiQZ43GycEdD+SrBDf1izFObDc8iORRcDs/V+t1CxEn3Yeas5
LSsj1T5W68FVaSMAd8Zp3WB5Gm/7XdERgov45ZrnuVtT1d4OwIvqhCR4+gb4u7+A
TWrFB8l9qlTwZba8542qfef4b2niJMIf3bF39EECgYBLYyk8RnNNHPsNMqifFV+P
paO4z7GHIIQBJEscpO8Amob96UZn1jP27OX10qIrnUBS1rX+S5SVboQ6MPxMMvmL
tDTR1RpClQXYcKf2IgRB9kyYz3gOSd9e/GhH/8YaMDoJneBIm1eVEnBIpli4M2wr
MfHT+VW3l0Y9cj9uw4R0vw==
-----END PRIVATE KEY-----"
        certificate: "-----BEGIN CERTIFICATE-----
MIIEATCCAumgAwIBAgIUUCvvJFp60VZWAaUCJBl7e6yw8wgwDQYJKoZIhvcNAQEL
BQAwgY8xCzAJBgNVBAYTAkNIMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQK
DBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQxITAfBgNVBAMMGGppbWlsLW51Yy5k
eW5kbnMuY2Vybi5jaDElMCMGCSqGSIb3DQEJARYWamltaWxkZXNhaTQyQGdtYWls
LmNvbTAeFw0yMjAzMTYxNTE2MDlaFw0yMzAzMTYxNTE2MDlaMIGPMQswCQYDVQQG
EwJDSDETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50ZXJuZXQgV2lk
Z2l0cyBQdHkgTHRkMSEwHwYDVQQDDBhqaW1pbC1udWMuZHluZG5zLmNlcm4uY2gx
JTAjBgkqhkiG9w0BCQEWFmppbWlsZGVzYWk0MkBnbWFpbC5jb20wggEiMA0GCSqG
SIb3DQEBAQUAA4IBDwAwggEKAoIBAQC+CTlf/usQLrcNdzwYIppDMYHjTBZDb5jq
Iwnlj7hHcLGtPzTHkq8Ngw+8Jz3r+iIr3ppJNxiS6FOO3uXAwMgqk8VOReRJ8w0b
7Emi2BiwsHtKNS/m7+Bi1ide/Pl6M3GCTeWhNB71puwrpX8Gh7STMraBNSdGCzc9
c+foyj6ffAx+86/VTBebhaHaU+c99XOSRpWP4SlDQSm2nLdei1lFfjxGyjscEqSL
IllJUji2ZzyJLxKwWWy2z7VNhcIvf2N8wI3xQUI/7IcP0qO/jOwgtlI/n9eSlNlO
oiJ9lMnbw/IjhQAwS5ffHEE7SrvxjElPPWQdQRtfLTfACA0gOQh1AgMBAAGjUzBR
MB0GA1UdDgQWBBSb6zGw+09+tL2iaX8/6V2ti1ZwqjAfBgNVHSMEGDAWgBSb6zGw
+09+tL2iaX8/6V2ti1ZwqjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUA
A4IBAQBlLqS6j098prRVBRLj8nBh5AsZcWz81vBjHlKe1XBFqbnmAjB9HPsK7eNZ
AGucC7OzQVaE7UQg0mjJbPRxakK8EsSWsj5YTh9rGtGsyy1zvvqPq0AYnYPoLMlq
j8Flz0ziyhOv8fviprLhYWI7EUAQNdeGQtWBN6sLYs9cNV6mw3DHmznSBvDxF/Nv
G3nBtP8zZ9C3l/T4pV/LQOk99o/HNWpBNdQZw2qOWNkX/HUEh2rTMTr2Wx1Y/Yku
RGamhJyTOBvy8OPDZPEoBCFdFu5V+co5GMosk1RnuCwjCH63lbBJrZhTgQE3Pux1
jpC/LuTa+mYUb7NY3xShLQTxoY5Q
-----END CERTIFICATE-----"
  service:
    type: ClusterIP
  staticSiteConfigmap: sciencebox-landing-page-cfgmap
